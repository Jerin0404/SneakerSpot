<%- include("../../views/partials/admin/header") %>
<head>
    <style>
        .error-message {
            color: red;
            display: none;
        }
    </style>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cropperjs/dist/cropper.min.css">
</head>

<section class="content-main">
    <div class="row">
        <div class="col-9">
            <div class="content-header">
                <h2 class="content-title">Edit Product</h2>
            </div>
        </div>

        <div class="col-lg-6">
            <div class="card mb-4">
                <div class="card-body">
                    <form method="post" action="/admin/editProduct/<%= product._id %>" enctype="multipart/form-data" id="editProductForm">
                        
                        <div class="mb-4">
                            <label for="product_name" class="form-label">Product Name</label>
                            <input type="text" name="productName" id="productName" value="<%= product.productName %>" class="form-control border">
                            <div id="productName-error" class="error-message"></div>
                        </div>

                        <div class="col-lg-4 mb-4">
                            <label class="form-label">Brand</label>
                            <select class="form-select border" name="brand" id="brand">
                                <% for (let i = 0; i < brand.length; i++) { %>
                                    <option value="<%= brand[i].brandName %>" <%= product.brand === brand[i].brandName ? 'selected' : '' %>>
                                        <%= brand[i].brandName %>
                                    </option>
                                <% } %>
                            </select>
                            <div id="brand-error" class="error-message"></div>
                        </div>

                        <div class="mb-4">
                            <label class="form-label">Full description</label>
                            <textarea name="descriptionData" id="descriptionData" class="form-control border" rows="4"><%= product.description %></textarea>
                            <div id="description-error" class="error-message"></div>
                        </div>

                        <div class="row">
                            <div class="col-lg-4">
                                <div class="mb-4">
                                    <label class="form-label">Regular Price ($)</label>
                                    <input name="regularPrice" id="regularPrice" type="text" value="<%= product.regularPrice %>" class="form-control border">
                                    <div id="regularPrice-error" class="error-message"></div>
                                </div>
                            </div>

                            <div class="col-lg-4">
                                <div class="mb-4">
                                    <label class="form-label">Sale Price ($)</label>
                                    <input name="salePrice" id="salePrice" type="text" value="<%= product.salePrice %>" class="form-control border">
                                    <div id="salePrice-error" class="error-message"></div>
                                </div>
                            </div>

                            <div class="col-lg-4">
                                <div class="mb-4">
                                    <label class="form-label">Quantity</label>
                                    <input name="quantity" id="quantity" type="text" value="<%= product.quantity %>" class="form-control border">
                                    <div id="quantity-error" class="error-message"></div>
                                </div>
                            </div>
                        </div>

                        <div class="mb-4">
                            <label class="form-label">Color</label>
                            <input name="color" id="color" type="text" value="<%= product.color %>" class="form-control border">
                            <div id="color-error" class="error-message"></div>
                        </div>

                        <div class="mb-4">
                            <label class="form-label">Category</label>
                            <select class="form-select border" name="category" id="category">
                                <% for (let i = 0; i < cat.length; i++) { %>
                                    <option value="<%= cat[i].name %>" <%= product.category === cat[i].name ? 'selected' : '' %>>
                                        <%= cat[i].name %>
                                    </option>
                                <% } %>
                            </select>
                            <div id="category-error" class="error-message"></div>
                        </div>

                        <div class="mb-4">
                            <label class="form-label">Upload Image</label>
                            <input class="form-control" type="file" name="images" id="input1" accept="image/png, image/jpeg, image/jpg">
                            <div id="images-error" class="error-message"></div>
                        </div>

                        <input type="hidden" id="imageDatas" value="<%= product.imageDatas %>">

                        <div>
                            <button class="btn btn-md rounded font-sm hover-up" type="submit">Update</button>
                        </div>

                    </form>
                </div>
            </div>
        </div>
    </div>
</section>

<script src="https://cdn.jsdelivr.net/npm/cropperjs/dist/cropper.min.js"></script>
<script>
    function validateForm() {
        console.log("Validating form...");
        clearErrorMessages();

        function getValue(selector) {
            const element = document.querySelector(selector);
            return element ? element.value.trim() : "";
        }

        const name = getValue("#productName");
        const description = getValue("#descriptionData");
        const price = getValue("#regularPrice");
        const salePrice = getValue("#salePrice");
        const quantity = getValue("#quantity");
        const color = getValue("#color");
        const category = getValue("#category");
        const images = document.getElementById("input1");
        const imageDatas = document.getElementById("imageDatas")?.value || "";

        let isValid = true;

        if (!name) {
            displayErrorMessage("productName-error", "Please enter a product name.");
            isValid = false;
        }
        if (!description) {
            displayErrorMessage("description-error", "Please enter a product description.");
            isValid = false;
        }
        if (!/^\d+(\.\d{1,2})?$/.test(price) || parseFloat(price) < 0) {
            displayErrorMessage("regularPrice-error", "Please enter a valid price.");
            isValid = false;
        }
        if (!/^\d+(\.\d{1,2})?$/.test(salePrice) || parseFloat(salePrice) < 0) {
            displayErrorMessage("salePrice-error", "Please enter a valid sale price.");
            isValid = false;
        }
        if (!/^\d+$/.test(quantity) || parseInt(quantity) < 0) {
            displayErrorMessage("quantity-error", "Please enter a valid quantity.");
            isValid = false;
        }
        if (!color) {
            displayErrorMessage("color-error", "Please enter a color.");
            isValid = false;
        }
        if (!imageDatas && images.files.length === 0) {
            displayErrorMessage("images-error", "Please select an image.");
            isValid = false;
        }

        return isValid;
    }

    function displayErrorMessage(elementId, message) {
        const errorElement = document.getElementById(elementId);
        if (errorElement) {
            errorElement.innerText = message;
            errorElement.style.display = "block";
        }
    }

    function clearErrorMessages() {
        document.querySelectorAll(".error-message").forEach(element => {
            element.innerText = "";
            element.style.display = "none";
        });
    }

    document.getElementById("editProductForm").onsubmit = function (event) {
        if (!validateForm()) {
            event.preventDefault();
        }
    };
</script>

<%- include("../../views/partials/admin/footer") %>
